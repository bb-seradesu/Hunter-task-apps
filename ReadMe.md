# ハンタータスク シミュレーション（Streamlit）

このプロジェクトは、20×20 のグリッドで「2体のハンターが2体の獲物を捕獲する」タスクを、Streamlit 上で動かすシミュレーションです。
AI同士のシミュレーションだけでなく、プレイヤーがハンターを操作してAIと協力（または競合）するモードも搭載しています。

## 特徴
- **マルチモード**: 「AI and AI」モードと「Player and AI」モードを切り替え可能。
- **マニュアル操作**: プレイヤーは画面上のボタンまたはキーボード（WASD）でハンターを操作可能。
- **視認性の向上**: エージェントごとの色分け（青: Player, 赤: AI, 緑: Prey）と獲物番号の表示。
- **AI遅延動作**: プレイヤー操作時、AIが少し遅れて行動することで、ターン制のようなリズムを実現。

## 対象環境
- OS: macOS / Linux / Windows
- Python: 3.10 〜 3.12 を推奨
- パッケージ管理: pip

## セットアップ（コマンドだけで実行可能）
以下のコマンドを順に実行してください。

```bash
# 1) 仮想環境を作成して有効化
python3 -m venv .venv
# macOS / Linux
source .venv/bin/activate
# Windows (PowerShell)
.venv\Scripts\Activate.ps1

# 2) pip を更新して依存関係をインストール
python -m pip install --upgrade pip
pip install -r requirements.txt
```

## 起動
```bash
streamlit run main.py
```
ブラウザが開かない場合は、表示された URL（例: http://localhost:8501）をブラウザで開いてください。終了する場合は、ターミナルで Ctrl+C を押します。

## 使い方

### 1. ゲームモードの選択（サイドバー）
- **AI and AI**: 2体のハンターが両方ともAIによって制御されます。「1ステップ進む」ボタンで進行します。
- **Player and AI**: Hunter 0 をプレイヤーが操作し、Hunter 1 をAIが操作します。

### 2. ハンター制御モード（サイドバー）
- **Simple**: 旧「Lv0」。固定のターゲットに最短方針で1歩進む単純なルールベースAIです。
- **Lv0 (Q)**: 旧「Q」。学習済みQテーブル（`q_table.pkl`）を用いて行動を選択するAIです（論文のLv.0相当）。
- **Manual**: プレイヤー操作（「Player and AI」モード選択時に Hunter 0 に自動適用）。

### 3. 操作方法（Player and AI モード）
Hunter 0 を以下のいずれかの方法で操作できます。
- **画面上のボタン**: 「↑」「↓」「←」「→」「・（待機）」ボタンをクリック。
- **キーボード (WASD)**:
    - `w`: 上
    - `a`: 左
    - `s`: 下
    - `d`: 右
    - `Space`: 待機
    ※ キーボード操作時は、ブラウザのページ内にフォーカスがある必要があります。

### 4. 画面の見方
- **グリッド**:
    - **青/水色 (▲)**: Hunter 0 (Player / AI)
    - **赤 (▼)**: Hunter 1 (AI)
    - **緑 (●)**: 獲物 (Prey)。数字 (0, 1) で識別可能。
- **ステータス**: 現在のステップ数や捕獲状況が表示されます。

## Qテーブルの自動ロード
- 制御モードを「Lv0 (Q)」にした場合、以下のファイルが自動で読み込まれます。
  - Hunter 0: `q_table.pkl`
  - Hunter 1: `q_table.pkl2`
- これらのファイルはプロジェクトのルートに置いてください。

## 構成（主要ファイル）
リファクタリングにより、ソースコードは `src/` ディレクトリに整理されています。

- `main.py`: アプリケーションのエントリーポイント（全体の調整役）。
- `src/`
    - `config.py`: 定数定義。
    - `game_logic.py`: シミュレーションのコアロジック（移動、判定など）。
    - `ui/`
        - `sidebar.py`: サイドバーの設定画面ロジック。
        - `components.py`: グリッド描画（Matplotlib）。
    - `agents/`
        - `lv0.py`: Simpleエージェントのロジック。
        - `q_learning.py`: Q学習エージェントのロジック。
        - `manual.py`: マニュアル操作用エージェント。
        - `q_utils.py`: Q学習のユーティリティ。
    - `env/`
        - `game_env.py`: 環境定義（グリッド、トーラス移動）。

## ライセンス・参考
- 研究・学習用のサンプルです。
- 参考: 「他者理解と社会性の獲得メカニズム」におけるハンタータスク
